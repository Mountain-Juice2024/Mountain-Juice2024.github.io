
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rate the Teachers</title>
    <link rel="stylesheet" href="style.css" />
    <link
      id="favicon"
      rel="icon"
      href="https://cdn.glitch.global/f26cb8e4-4a0c-4568-87b5-ce246fc28723/favicon.ico?v=1741180185473"
      type="image/x-icon"
    />
  </head>
  <body>
    <div id="grade-display" class="grade-display"></div>
    <p id="disclaimer">Every Vote is Completely Anonymous</p>

    <div id="grade-overlay" class="grade-overlay">
      <div class="grade-container">
        <h2>Select Your Grade</h2>
        <select id="grade-select">
          <option value="">-- Choose Grade --</option>
          <option value="Year 7">Year 7</option>
          <option value="Year 8">Year 8</option>
          <option value="Year 9">Year 9</option>
          <option value="Year 10">Year 10</option>
          <option value="Year 11">Year 11</option>
          <option value="Year 12">Year 12</option>
        </select>
        <button id="start-rating-btn" class="start-rating-btn">
          Start Rating
        </button>
      </div>
    </div>

    <div id="loading-screen" class="loading-screen">
      <div class="spinner"></div>
    </div>

    <h1 id="rate-my-teachers">Rate The Teachers</h1>

    <input type="text" id="search-bar" placeholder="Search for a teacher..." />

    <div id="sort-controls">
      <label for="sort-order">Sort by Rating:</label>
      <select id="sort-order">
        <option value="">-- Select Filter --</option>
        <option value="desc">Highest to Lowest</option>
        <option value="asc">Lowest to Highest</option>
      </select>
    </div>

    <div id="teacher-container"></div>

    <div id="breakdown-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modal-breakdown-content"></div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        where,
        deleteDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBLCiLKSbS-n9_nVw9BkKT7f24iG8X2140",
        authDomain: "ratemyteacher-3a964.firebaseapp.com",
        projectId: "ratemyteacher-3a964",
        storageBucket: "ratemyteacher-3a964.firebasestorage.app",
        messagingSenderId: "497606683649",
        appId: "1:497606683649:web:c1c0b31920d40543086400",
        measurementId: "G-HEQNCG3NJW",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const teachers = [
        "Sharon Collins",
        "Patrick Toohey",
        "Christine Walton",
        "Kerri Buckley",
        "Catharine Hannan",
        "Josh Maudsley",
        "Haydn Perugini",
        "Kelly Jack",
        "Sarah Barnes",
        "Dane Stevenson",
        "Paddy Tully",
        "Sharon Wilson",
   
      ];

      const teacherRoles = {
        "Sharon Collins": "College Principal",
        "Patrick Toohey": "Deputy Principal",
        "Christine Walton": "Business Manager",
        "Kerri Buckley": "Assistant Principal (Acting)",
        "Catharine Hannan": "Assistant Principal (Leave)",
        "Josh Maudsley": "Assistant Principal - Teaching and Learning",
        "Haydn Perugini":
          "Assistant Principal - Human Resources and Organisation",
        "Carol Iezzi": "Uniform Shop Convenor",
      };

      let currentFilteredTeachers = [...teachers];

      const container = document.getElementById("teacher-container");
      const searchBar = document.getElementById("search-bar");
      const sortOrderSelect = document.getElementById("sort-order");

      const teacherImages = {
        "Amanda Jamieson": "https://i.postimg.cc/J0kHxz1P/amandajamieson.png",
        "Cameron Millach": "https://i.postimg.cc/KcRVPkTx/cameronmillach.png",
    
      };

      function displayTeachers(teachersList) {
        container.innerHTML = ""; // Clear previous teacher cards
        teachersList.forEach((teacher) => {
          const teacherDiv = document.createElement("div");
          teacherDiv.classList.add("teacher-card");

          const teacherImage =
            teacherImages[teacher] ||
            "https://i.postimg.cc/26VsS2NL/employee-worker-avatar-profile-icon-isolated-on-gray-background-vector.jpg";

          teacherDiv.innerHTML = `
                <button class="breakdown-btn" data-teacher="${teacher}">•••</button>
                <h2>${teacher}</h2>
                <small class="teacher-role">${
                  teacherRoles[teacher] || ""
                }</small>
                <img src="${teacherImage}" alt="${teacher}'s photo" class="teacher-image"/>
                <div class="stars" data-teacher="${teacher}">
                    <span class="star">☆</span>
                    <span class="star">☆</span>
                    <span class="star">☆</span>
                    <span class="star">☆</span>
                    <span class="star">☆</span>
                </div>
                <div class="button-container">
                  <button class="submit-btn" data-teacher="${teacher}">Submit</button>
                  <button class="remove-btn" data-teacher="${teacher}" style="display: none;">Remove</button>
                </div>
                <p class="average-rating" data-teacher="${teacher}">Average Rating: --</p>
                <p class="vote-count" data-teacher="${teacher}">Votes: --</p>
                <p class="voted-indicator" data-teacher="${teacher}" style="display: none;">✔ You have already voted!</p>
            `;
          container.appendChild(teacherDiv);
        });
      }

      async function filterTeachers() {
        const searchQuery = searchBar.value.toLowerCase();
        currentFilteredTeachers = teachers.filter((teacher) =>
          teacher.toLowerCase().includes(searchQuery)
        );
        displayTeachers(currentFilteredTeachers);
        await loadRatings();
        await checkIfVotedForTeachers();
      }

      searchBar.addEventListener("input", filterTeachers);
      sortOrderSelect.addEventListener("change", function () {
        if (sortOrderSelect.value === "") {
          filterTeachers();
        } else {
          sortTeacherCards();
        }
      });

      const userId = localStorage.getItem("userId") || generateUniqueId();
      if (!localStorage.getItem("userId")) {
        localStorage.setItem("userId", userId);
      }

      function generateUniqueId() {
        return "user_" + Math.random().toString(36).substring(2, 15);
      }

      document.addEventListener("click", function (event) {
        if (event.target.classList.contains("star")) {
          const starDiv = event.target.parentNode;
          const stars = Array.from(starDiv.children);
          const rating = stars.indexOf(event.target) + 1;
          starDiv.dataset.rating = rating;
          updateStars(starDiv, rating);
        }
      });

      function updateStars(starDiv, rating) {
        const stars = starDiv.children;
        for (let i = 0; i < 5; i++) {
          stars[i].textContent = i < rating ? "★" : "☆";
        }
      }

      async function checkIfVotedForTeachers() {
        for (const teacher of currentFilteredTeachers) {
          const q = query(
            collection(db, "ratings"),
            where("teacher", "==", teacher),
            where("userId", "==", userId)
          );
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            const indicator = document.querySelector(
              `.voted-indicator[data-teacher="${teacher}"]`
            );
            if (indicator) {
              indicator.style.display = "inline";
            }
            const starDiv = document.querySelector(
              `.stars[data-teacher="${teacher}"]`
            );
            const submitButton = document.querySelector(
              `.submit-btn[data-teacher="${teacher}"]`
            );
            const removeButton = document.querySelector(
              `.remove-btn[data-teacher="${teacher}"]`
            );
            if (starDiv) {
              starDiv.style.pointerEvents = "none";
            }
            if (submitButton) {
              submitButton.disabled = true;
            }
            if (removeButton) {
              removeButton.style.display = "inline";
            }
            const userRating = querySnapshot.docs[0].data().rating;
            if (starDiv) {
              updateStars(starDiv, userRating);
            }
          }
        }
      }

      document.addEventListener("click", async function (event) {
        if (event.target.classList.contains("submit-btn")) {
          const teacher = event.target.dataset.teacher;
          const starDiv = document.querySelector(
            `.stars[data-teacher="${teacher}"]`
          );
          const rating = parseInt(starDiv.dataset.rating || 0);
          
          // Only allow submission if a rating has been selected
          if (rating === 0) {
            alert("Please select a rating before submitting.");
            return;
          }

          const q = query(
            collection(db, "ratings"),
            where("teacher", "==", teacher),
            where("userId", "==", userId)
          );
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            const votedIndicator = document.querySelector(
              `.voted-indicator[data-teacher="${teacher}"]`
            );
            if (votedIndicator) {
              votedIndicator.style.display = "inline";
            }
            starDiv.style.pointerEvents = "none";
            event.target.disabled = true;
            return;
          }

          event.target.textContent = "Submitting...";
          event.target.disabled = true;
          // Change the button text back to "Submit" after 5 seconds
          setTimeout(() => {
            event.target.textContent = "Submit";
          }, 2500);

          try {
            await addDoc(collection(db, "ratings"), {
              teacher,
              rating,
              userId,
            });
            await loadRatings();
            await checkIfVotedForTeachers();
          } catch (error) {
            console.error("Error adding rating: ", error);
            event.target.textContent = "Submit";
            event.target.disabled = false;
          }
        }
      });

      document.addEventListener("click", async function (event) {
        if (event.target.classList.contains("remove-btn")) {
          const teacher = event.target.dataset.teacher;
          const starDiv = document.querySelector(
            `.stars[data-teacher="${teacher}"]`
          );
          const q = query(
            collection(db, "ratings"),
            where("teacher", "==", teacher),
            where("userId", "==", userId)
          );
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            const voteDocId = querySnapshot.docs[0].id;
            await deleteDoc(doc(db, "ratings", voteDocId));
            const votedIndicator = document.querySelector(
              `.voted-indicator[data-teacher="${teacher}"]`
            );
            if (votedIndicator) {
              votedIndicator.style.display = "none";
            }
            if (starDiv) {
              starDiv.style.pointerEvents = "auto";
              updateStars(starDiv, 0);
              starDiv.dataset.rating = 0;
            }
            const submitButton = document.querySelector(
              `.submit-btn[data-teacher="${teacher}"]`
            );
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.textContent = "Submit";
            }
            event.target.style.display = "none";
            await loadRatings();
          }
        }
      });

      document.addEventListener("click", async function (event) {
        if (event.target.classList.contains("breakdown-btn")) {
          const teacher = event.target.dataset.teacher;
          const q = query(
            collection(db, "ratings"),
            where("teacher", "==", teacher)
          );
          const querySnapshot = await getDocs(q);
          let counts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const r = data.rating;
            if (r >= 1 && r <= 5) {
              counts[r]++;
            }
          });
          const modalContentDiv = document.getElementById(
            "modal-breakdown-content"
          );
          modalContentDiv.innerHTML = `
  <h2>${teacher} Ratings</h2>
  <p><span class="gold-stars">★★★★★</span> - ${counts[5]}</p>
  <p><span class="gold-stars">★★★★☆</span> - ${counts[4]}</p>
  <p><span class="gold-stars">★★★☆☆</span> - ${counts[3]}</p>
  <p><span class="gold-stars">★★☆☆☆</span> - ${counts[2]}</p>
  <p><span class="gold-stars">★☆☆☆☆</span> - ${counts[1]}</p>
`;

          document.getElementById("breakdown-modal").style.display = "block";
        }
      });

      document.addEventListener("click", function (event) {
        if (event.target.classList.contains("close")) {
          document.getElementById("breakdown-modal").style.display = "none";
        }
      });

      window.addEventListener("click", function (event) {
        const modal = document.getElementById("breakdown-modal");
        if (event.target === modal) {
          modal.style.display = "none";
        }
      });

      async function loadRatings() {
        const querySnapshot = await getDocs(collection(db, "ratings"));
        const ratings = {};

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (!ratings[data.teacher]) {
            ratings[data.teacher] = { total: 0, count: 0 };
          }
          ratings[data.teacher].total += data.rating;
          ratings[data.teacher].count += 1;
        });

        const displayedTeachers = document.querySelectorAll(".teacher-card");
        displayedTeachers.forEach((teacherDiv) => {
          const teacherName = teacherDiv.querySelector("h2").textContent;
          if (ratings[teacherName]) {
            const avgRating = (
              ratings[teacherName].total / ratings[teacherName].count
            ).toFixed(1);
            const voteCount = ratings[teacherName].count;
            teacherDiv.querySelector(
              ".average-rating"
            ).textContent = `Average Rating: ${avgRating}`;
            teacherDiv.querySelector(
              ".vote-count"
            ).textContent = `Votes: ${voteCount}`;
            teacherDiv.dataset.avgRating = avgRating;
            teacherDiv.dataset.voteCount = voteCount;
          } else {
            teacherDiv.querySelector(
              ".average-rating"
            ).textContent = `Average Rating: 0`;
            teacherDiv.querySelector(".vote-count").textContent = `Votes: 0`;
            teacherDiv.dataset.avgRating = 0;
            teacherDiv.dataset.voteCount = 0;
          }
        });
        if (sortOrderSelect.value !== "") {
          sortTeacherCards();
        }
      }

      function sortTeacherCards() {
        const sortOrder = sortOrderSelect.value;
        if (sortOrder === "") return;
        const teacherCards = Array.from(
          document.querySelectorAll(".teacher-card")
        );
        teacherCards.sort((a, b) => {
          const ratingA = parseFloat(a.dataset.avgRating) || 0;
          const ratingB = parseFloat(b.dataset.avgRating) || 0;
          const voteCountA = parseInt(a.dataset.voteCount) || 0;
          const voteCountB = parseInt(b.dataset.voteCount) || 0;
          if (sortOrder === "asc") {
            if (ratingA !== ratingB) {
              return ratingA - ratingB;
            } else {
              return voteCountA - voteCountB;
            }
          } else {
            if (ratingA !== ratingB) {
              return ratingB - ratingA;
            } else {
              return voteCountB - voteCountA;
            }
          }
        });
        teacherCards.forEach((card) => container.appendChild(card));
      }

      displayTeachers(teachers);
      loadRatings();
      checkIfVotedForTeachers();

      document.addEventListener("DOMContentLoaded", function () {
        const overlay = document.getElementById("grade-overlay");
        const gradeSelect = document.getElementById("grade-select");
        const startButton = document.getElementById("start-rating-btn");
        const loadingScreen = document.getElementById("loading-screen");
        const gradeDisplay = document.getElementById("grade-display");

        const selectedGrade = localStorage.getItem("userGrade");

        if (selectedGrade) {
          loadingScreen.style.display = "flex";
          setTimeout(() => {
            loadingScreen.style.display = "none";
            overlay.style.display = "none";
            gradeDisplay.textContent = selectedGrade;
            gradeDisplay.style.display = "block";
          }, 2000);
        }

        startButton.addEventListener("click", function () {
          const grade = gradeSelect.value;
          if (grade) {
            localStorage.setItem("userGrade", grade);
            overlay.style.display = "none";
            loadingScreen.style.display = "flex";
            setTimeout(() => {
              loadingScreen.style.display = "none";
              gradeDisplay.textContent = grade;
              gradeDisplay.style.display = "block";
            }, 2000);
          } else {
            alert("Please select your grade before proceeding.");
          }
        });
      });

      window.addEventListener("load", function () {
        setTimeout(function () {
          document.querySelector(".loader-overlay").style.display = "none";
        }, 2000);
      });
    </script>
  </body>
</html>
